name: Release SDK

on:
    workflow_dispatch

jobs:
    # SDK release is done from public/main branch.
    confirm-main-branch:
        name: Confirm release is run on public/main branch
        uses: mParticle/mparticle-workflows/.github/workflows/sdk-release-repo-branch-check.yml@main

    # All new code is stored in internal/development. Release from public/main will merge changes from internal/development into
    # public/main, then run semantic-release on public/main to update changelog and release notes. Before semantic-release publishes
    # to npm, it builds the dist/ folder. Finally, commits from public/main are synced back to internal/main and internal/development.

    react-tests:
        name: Run React Native Unit Tests
        runs-on: ubuntu-latest
        needs: ['confirm-main-branch']
        steps:
            - name: Checkout
              uses: actions/checkout@v6
            - uses: actions/setup-node@v6.2.0
              with:
                node-version: 24
                cache: yarn
                cache-dependency-path: yarn.lock

            - name: Install node modules
              run: yarn install
    
            - name: Run test
              run: yarn test

    android-unit-tests:
        name: Run Android Unit Tests
        runs-on: ubuntu-latest
        needs: ['confirm-main-branch']
        steps:
            - name: Checkout
              uses: actions/checkout@v6
            
            - name: Run Android Unit Tests
              run: echo "pwd"; pwd; echo "ls:"; ls; cd android; ./gradlew test

    release-and-sync-repos:
        name: Release and Sync Repos
        runs-on: ubuntu-latest
        needs: ['android-unit-tests', 'react-tests']
        # OIDC permissions for npm trusted publishing
        permissions:
          contents: write
          issues: write
          pull-requests: write
          id-token: write # Required for OIDC authentication with npm
        steps:
          - name: Checkout internal/development
            uses: actions/checkout@v6
             
          - name: Setup Node.js
            uses: actions/setup-node@v6.2.0
            with:
              node-version: 24
              registry-url: 'https://registry.npmjs.org'

          - name: Install node modules
            run: yarn install

          - name: Ensure npm CLI supports OIDC
            run: npm install -g npm@latest

          - name: Build SDK
            run: yarn build

          - name: Release
            run: ./release.sh